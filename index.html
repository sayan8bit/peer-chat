<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>PeerJS QR Chat</title>
    <style>
      body {
        font-family: Arial;
        background: #121212;
        color: #fff;
        padding: 20px;
        text-align: center;
      }
      input,
      button {
        padding: 10px;
        margin: 5px;
        border: none;
        border-radius: 4px;
      }
      #chat {
        background: #222;
        padding: 10px;
        height: 300px;
        overflow-y: auto;
        margin: 10px auto;
        max-width: 600px;
        text-align: left;
      }
      .message {
        padding: 5px 10px;
        margin: 5px 0;
        max-width: 70%;
        border-radius: 10px;
      }
      .me {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
      }
      .friend {
        background-color: #444;
        color: white;
        margin-right: auto;
        text-align: left;
      }
      #qrcode {
        margin-top: 10px;
      }
      #status {
        color: lightgreen;
      }
    </style>
  </head>
  <body>
    <h1>üîó P2P QR Chat with PeerJS</h1>
    <div>
      Your Nickname: <input id="nickname" placeholder="Nickname" value="Me" />
    </div>
    <div>Your ID: <span id="my-id">Loading...</span></div>
    <div id="qrcode"></div>
    <hr />
    <input id="peer-id-input" placeholder="Friend's ID" />
    <button onclick="connectToPeer()">Connect</button>
    <div id="status">Not connected</div>

    <div id="chat"></div>

    <input id="msg" placeholder="Type message" />
    <button onclick="sendMsg()">Send</button>
    <br />
    <input type="file" id="fileInput" />
    <button onclick="sendFile()">Send File</button>

    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
      const chatBox = document.getElementById("chat");
      const msgInput = document.getElementById("msg");
      const peerIdInput = document.getElementById("peer-id-input");
      const nicknameInput = document.getElementById("nickname");
      const status = document.getElementById("status");

      let conn = null;
      let peerId = localStorage.getItem("peer_id");
      const peer = new Peer(peerId || undefined);

      peer.on("open", (id) => {
        document.getElementById("my-id").textContent = id;
        localStorage.setItem("peer_id", id);
        new QRCode("qrcode", id);
      });

      peer.on("connection", (incoming) => {
        incoming.on("open", () => {
          conn = incoming;
          status.textContent = `Connected to ${conn.peer}`;
          addSystemMessage(`‚úÖ Connected to ${conn.peer}`);

          conn.on("data", (data) => {
            if (typeof data === "string") {
              addMessage(data, "friend");
            } else if (data instanceof ArrayBuffer) {
              const blob = new Blob([data]);
              const url = URL.createObjectURL(blob);
              addMessage(
                `üìÅ <a href="${url}" download="file">Download file</a>`,
                "friend"
              );
            }
          });

          conn.on("close", () => {
            status.textContent = `üîå Disconnected from ${conn.peer}`;
            addSystemMessage(`üîå Disconnected from ${conn.peer}`);
          });
        });
      });

      function connectToPeer() {
        const id = peerIdInput.value.trim();
        if (!id) return;

        const outgoing = peer.connect(id);
        outgoing.on("open", () => {
          conn = outgoing;
          status.textContent = `Connected to ${conn.peer}`;
          addSystemMessage(`‚úÖ Connected to ${conn.peer}`);

          conn.on("data", (data) => {
            if (typeof data === "string") {
              addMessage(data, "friend");
            } else if (data instanceof ArrayBuffer) {
              const blob = new Blob([data]);
              const url = URL.createObjectURL(blob);
              addMessage(
                `üìÅ <a href="${url}" download="file">Download file</a>`,
                "friend"
              );
            }
          });

          conn.on("close", () => {
            status.textContent = `üîå Disconnected from ${conn.peer}`;
            addSystemMessage(`üîå Disconnected from ${conn.peer}`);
          });
        });
      }

      function sendMsg() {
        const msg = msgInput.value.trim();
        const name = nicknameInput.value || "Me";
        if (!msg || !conn || !conn.open) return;
        const formatted = `${name}: ${msg}`;
        conn.send(formatted);
        addMessage(formatted, "me");
        msgInput.value = "";
      }

      function sendFile() {
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];
        if (!file || !conn || !conn.open) return;

        const reader = new FileReader();
        reader.onload = () => {
          conn.send(reader.result);
          addMessage(`üìÅ ${file.name} sent`, "me");
        };
        reader.readAsArrayBuffer(file);
      }

      function addMessage(text, sender) {
        const msgDiv = document.createElement("div");
        msgDiv.className = `message ${sender}`;
        msgDiv.innerHTML = text;
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function addSystemMessage(text) {
        const msgDiv = document.createElement("div");
        msgDiv.style.color = "lightgreen";
        msgDiv.textContent = text;
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    </script>
  </body>
</html>
