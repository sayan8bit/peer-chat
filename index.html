<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Chat 2.0</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @media (max-width: 640px) {
        .sidebar {
          display: none;
        }
        .chat-only {
          width: 100%;
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 h-screen flex flex-col sm:flex-row">
    <!-- Sidebar -->
    <div
      class="sidebar w-full sm:w-1/3 lg:w-1/4 bg-white border-r flex flex-col"
    >
      <div class="p-4 border-b flex justify-between items-center">
        <h1 class="text-lg font-bold">Your ID</h1>
        <button id="showQRBtn" class="text-blue-500 text-sm">Show QR</button>
      </div>
      <div id="my-id" class="text-sm px-4 text-gray-600 break-words"></div>
      <div id="qr-container" class="hidden p-4">
        <canvas id="qrcode"></canvas>
      </div>
      <div class="p-4">
        <input
          id="peerIdInput"
          class="w-full border px-2 py-1 text-sm"
          placeholder="Enter Friend ID"
        />
        <button
          id="addUserBtn"
          class="w-full mt-2 bg-blue-500 text-white py-1 text-sm"
        >
          Add User
        </button>
      </div>
      <div class="overflow-y-auto flex-1 border-t">
        <ul id="userList" class="divide-y text-sm"></ul>
      </div>
    </div>

    <!-- Chat Section -->
    <div class="chat-only flex-1 flex flex-col">
      <div class="p-4 bg-white border-b flex justify-between items-center">
        <div id="currentUser" class="font-bold text-gray-700">
          No user selected
        </div>
        <div id="userStatus" class="text-sm text-gray-500 ml-2">Offline</div>
      </div>
      <div
        id="chatArea"
        class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50"
      ></div>
      <div class="p-4 border-t bg-white flex items-center">
        <input
          id="msgInput"
          class="flex-1 border px-2 py-1 text-sm"
          placeholder="Type a message"
        />
        <input id="fileInput" type="file" class="ml-2 hidden" />
        <button
          id="sendFileBtn"
          class="ml-2 bg-yellow-400 text-sm px-2 py-1 rounded"
        >
          📎
        </button>
        <button
          id="sendBtn"
          class="ml-2 bg-green-500 text-white px-4 py-1 rounded"
        >
          Send
        </button>
      </div>
    </div>

    <script>
      let myId =
        localStorage.getItem("fixedPeerId") ||
        `user-${Math.random().toString(36).substr(2, 9)}`;
      localStorage.setItem("fixedPeerId", myId);

      const peer = new Peer(myId);
      const connections = {};
      const messages = JSON.parse(localStorage.getItem("chatMessages") || "{}");
      let currentPeerId = null;

      const myIdDiv = document.getElementById("my-id");
      const showQRBtn = document.getElementById("showQRBtn");
      const qrContainer = document.getElementById("qr-container");
      const qrcodeCanvas = document.getElementById("qrcode");
      const peerIdInput = document.getElementById("peerIdInput");
      const addUserBtn = document.getElementById("addUserBtn");
      const userList = document.getElementById("userList");
      const chatArea = document.getElementById("chatArea");
      const currentUser = document.getElementById("currentUser");
      const userStatus = document.getElementById("userStatus");
      const msgInput = document.getElementById("msgInput");
      const sendBtn = document.getElementById("sendBtn");
      const sendFileBtn = document.getElementById("sendFileBtn");
      const fileInput = document.getElementById("fileInput");

      peer.on("open", (id) => {
        myIdDiv.textContent = id;
        QRCode.toCanvas(qrcodeCanvas, id);
        loadStoredUsers();
      });

      showQRBtn.onclick = () => qrContainer.classList.toggle("hidden");

      addUserBtn.onclick = () => {
        const friendId = peerIdInput.value.trim();
        if (!friendId) return;
        saveUser(friendId);
        addUserToList(friendId);
        peerIdInput.value = "";
      };

      peer.on("connection", (conn) => {
        if (!connections[conn.peer]) setupConnection(conn, conn.peer);
      });

      function setupConnection(conn, id) {
        connections[id] = conn;
        messages[id] = messages[id] || [];

        conn.on("open", () => {
          updateUserStatus(id, true);
          saveUser(id);
          addUserToList(id);
        });

        conn.on("data", (data) => {
          data.timestamp = new Date().toLocaleTimeString();
          messages[id].push({ ...data, from: "them" });
          saveMessages();
          if (currentPeerId === id) renderMessages(id);
        });

        conn.on("close", () => updateUserStatus(id, false));
      }

      function addUserToList(id) {
        if (document.querySelector(`[data-id='${id}']`)) return;
        const li = document.createElement("li");
        li.className =
          "flex justify-between items-center p-2 hover:bg-gray-100";
        li.dataset.id = id;

        const btn = document.createElement("button");
        btn.textContent = id;
        btn.className = "flex-1 text-left";
        btn.onclick = () => {
          if (!connections[id]) setupConnection(peer.connect(id), id);
          currentPeerId = id;
          currentUser.textContent = id;
          renderMessages(id);
        };

        const del = document.createElement("button");
        del.textContent = "❌";
        del.onclick = () => {
          li.remove();
          removeUser(id);
        };

        li.append(btn, del);
        userList.appendChild(li);
      }

      function renderMessages(id) {
        chatArea.innerHTML = "";
        (messages[id] || []).forEach((msg) => {
          const div = document.createElement("div");
          div.className = `max-w-xs px-3 py-2 rounded-lg text-sm mb-1 ${
            msg.from === "me" ? "ml-auto bg-green-200" : "mr-auto bg-gray-300"
          }`;
          div.innerHTML =
            msg.text || msg.file
              ? `<a href="${msg.file}" download="${msg.name}">${msg.name}</a>`
              : "";
          const time = document.createElement("div");
          time.className = "text-xs text-gray-500 mt-1";
          time.textContent = msg.timestamp || "";
          div.appendChild(time);
          chatArea.appendChild(div);
        });
        chatArea.scrollTop = chatArea.scrollHeight;
      }

      sendBtn.onclick = () => {
        const text = msgInput.value.trim();
        if (!text || !currentPeerId) return;
        const conn = connections[currentPeerId];
        const timestamp = new Date().toLocaleTimeString();
        const data = { type: "msg", text, timestamp };
        conn.send(data);
        messages[currentPeerId].push({ ...data, from: "me" });
        msgInput.value = "";
        renderMessages(currentPeerId);
        saveMessages();
      };

      sendFileBtn.onclick = () => fileInput.click();
      fileInput.onchange = () => {
        const file = fileInput.files[0];
        if (!file || !currentPeerId) return;
        const conn = connections[currentPeerId];
        const timestamp = new Date().toLocaleTimeString();
        const data = { type: "file", name: file.name, blob: file, timestamp };
        conn.send(data);
        messages[currentPeerId].push({
          file: URL.createObjectURL(file),
          name: file.name,
          from: "me",
          timestamp,
        });
        renderMessages(currentPeerId);
        saveMessages();
      };

      function saveUser(id) {
        let users = JSON.parse(localStorage.getItem("peerUsers") || "[]");
        if (!users.includes(id)) {
          users.push(id);
          localStorage.setItem("peerUsers", JSON.stringify(users));
        }
      }

      function removeUser(id) {
        let users = JSON.parse(localStorage.getItem("peerUsers") || "[]");
        users = users.filter((u) => u !== id);
        localStorage.setItem("peerUsers", JSON.stringify(users));
      }

      function loadStoredUsers() {
        const users = JSON.parse(localStorage.getItem("peerUsers") || "[]");
        users.forEach(addUserToList);
      }

      function saveMessages() {
        localStorage.setItem("chatMessages", JSON.stringify(messages));
      }

      function updateUserStatus(id, online) {
        if (currentPeerId === id) {
          userStatus.textContent = online ? "Online" : "Offline";
        }
      }
    </script>
  </body>
</html>
