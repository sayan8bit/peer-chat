<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PeerJS WhatsApp Chat</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }
      #sidebar {
        width: 250px;
        background-color: #f1f1f1;
        padding: 10px;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
      }
      #chatContainer {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      #chatBox {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
        background-color: #e5ddd5;
      }
      #messageInput {
        display: flex;
        padding: 10px;
        background-color: #fff;
      }
      #messageInput input[type="text"] {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      #messageInput button {
        margin-left: 10px;
        padding: 10px;
      }
      .message {
        max-width: 60%;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 10px;
        clear: both;
      }
      .me {
        background-color: #dcf8c6;
        align-self: flex-end;
        margin-left: auto;
      }
      .friend {
        background-color: #fff;
        align-self: flex-start;
        margin-right: auto;
      }
      .peer-btn {
        display: block;
        padding: 10px;
        margin: 5px 0;
        background-color: #ddd;
        border: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
      }
      #qrPopup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
      }
      #qrPopupContent {
        background: white;
        padding: 20px;
        border-radius: 10px;
      }
    </style>
  </head>
  <body>
    <div id="sidebar">
      <button onclick="toggleQRPopup()">Show My QR</button>
      <div id="peerList"></div>
      <input id="friendIdInput" placeholder="Friend ID" />
      <button onclick="connectToFriend()">Connect</button>
    </div>

    <div id="chatContainer">
      <div id="chatBox"></div>
      <div id="messageInput">
        <input id="message" type="text" placeholder="Type a message..." />
        <button onclick="sendMessage()">Send</button>
        <button onclick="sendFile()">ðŸ“Ž</button>
      </div>
    </div>

    <div id="qrPopup" onclick="toggleQRPopup()">
      <div id="qrPopupContent">
        <canvas id="qrcode"></canvas>
      </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious"></script>
    <script>
      let peer = new Peer();
      let connections = {};
      let currentConnId = null;

      peer.on("open", (id) => {
        generateQR(id);
      });

      peer.on("connection", (conn) => {
        conn.on("open", () => {
          setupConnection(conn.peer, conn);
        });
      });

      function setupConnection(id, conn) {
        connections[id] = conn;
        addPeerButton(id);

        conn.on("data", (data) => {
          if (typeof data === "string") {
            appendMessage(data, "friend");
          } else {
            const blob = new Blob([data]);
            const url = URL.createObjectURL(blob);
            appendMessage(
              `<a href="${url}" download="file">ðŸ“Ž File</a>`,
              "friend",
              true
            );
          }
        });

        conn.on("close", () => {
          alert(`Disconnected from ${id}`);
        });
      }

      function addPeerButton(id) {
        if (!document.getElementById(`btn-${id}`)) {
          const btn = document.createElement("button");
          btn.textContent = id;
          btn.id = `btn-${id}`;
          btn.className = "peer-btn";
          btn.onclick = () => switchChat(id);
          document.getElementById("peerList").appendChild(btn);
        }
      }

      function switchChat(id) {
        currentConnId = id;
        document.getElementById("chatBox").innerHTML = ""; // Clear chat
      }

      function connectToFriend() {
        const id = document.getElementById("friendIdInput").value;
        if (!connections[id]) {
          const conn = peer.connect(id);
          conn.on("open", () => setupConnection(id, conn));
        }
      }

      function sendMessage() {
        const msg = document.getElementById("message").value;
        if (currentConnId && connections[currentConnId]) {
          connections[currentConnId].send(msg);
          appendMessage(msg, "me");
          document.getElementById("message").value = "";
        }
      }

      function sendFile() {
        const input = document.createElement("input");
        input.type = "file";
        input.onchange = () => {
          const file = input.files[0];
          if (file && currentConnId && connections[currentConnId]) {
            connections[currentConnId].send(file);
            appendMessage(
              `<a href="" download="${file.name}">ðŸ“Ž ${file.name}</a>`,
              "me",
              true
            );
          }
        };
        input.click();
      }

      function appendMessage(msg, sender, isHTML = false) {
        const div = document.createElement("div");
        div.className = `message ${sender}`;
        div.innerHTML = isHTML ? msg : escapeHtml(msg);
        document.getElementById("chatBox").appendChild(div);
        document.getElementById("chatBox").scrollTop =
          document.getElementById("chatBox").scrollHeight;
      }

      function escapeHtml(text) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        };
        return text.replace(/[&<>"']/g, (m) => map[m]);
      }

      function generateQR(id) {
        const qr = new QRious({
          element: document.getElementById("qrcode"),
          value: id,
          size: 200,
        });
      }

      function toggleQRPopup() {
        const qr = document.getElementById("qrPopup");
        qr.style.display = qr.style.display === "flex" ? "none" : "flex";
      }
    </script>
  </body>
</html>
