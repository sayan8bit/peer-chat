<!DOCTYPE html>
<html>
  <head>
    <title>QR Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f0f2f5;
      }
      .header {
        background: #128c7e;
        color: white;
        padding: 10px;
        text-align: center;
        font-size: 20px;
      }
      .container {
        display: flex;
        height: calc(100vh - 50px);
      }
      .users {
        width: 200px;
        background: #fff;
        border-right: 1px solid #ccc;
        overflow-y: auto;
      }
      .user {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }
      .user:hover,
      .user.active {
        background: #e0e0e0;
      }
      .chat {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .messages {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }
      .message {
        max-width: 60%;
        padding: 10px;
        margin: 5px;
        border-radius: 10px;
      }
      .me {
        align-self: flex-end;
        background: #dcf8c6;
      }
      .other {
        align-self: flex-start;
        background: #eee;
      }
      .input {
        display: flex;
        padding: 10px;
        background: #fff;
      }
      input[type="text"] {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      button {
        padding: 10px;
        margin-left: 5px;
      }
      #qrContainer {
        display: none;
        position: fixed;
        top: 50px;
        right: 10px;
        background: #fff;
        padding: 10px;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <div class="header">QR Chat</div>
    <div class="container">
      <div class="users" id="userList"></div>
      <div class="chat">
        <div class="messages" id="messages"></div>
        <div class="input">
          <input
            type="text"
            id="messageInput"
            placeholder="Type a message..."
          />
          <button onclick="sendMessage()">Send</button>
          <input
            type="file"
            id="fileInput"
            style="display: none"
            onchange="sendFile(event)"
          />
          <button onclick="document.getElementById('fileInput').click()">
            üìÅ
          </button>
        </div>
      </div>
    </div>

    <button
      onclick="toggleQR()"
      style="position: absolute; top: 10px; right: 10px"
    >
      Show QR
    </button>
    <div id="qrContainer"></div>

    <script>
      let peer = new Peer();
      let connections = {};
      let currentChat = null;

      peer.on("open", (id) => {
        console.log("My ID:", id);
        localStorage.setItem("peerID", id);
        QRCode.toCanvas(document.createElement("canvas"), id, (err, canvas) => {
          if (!err) {
            document
              .getElementById("qrContainer")
              .append("Your ID: ", id, document.createElement("br"), canvas);
          }
        });
      });

      peer.on("connection", (conn) => {
        conn.on("open", () => {
          setupConnection(conn);
        });
      });

      function connectTo(id) {
        let conn = peer.connect(id);
        conn.on("open", () => {
          setupConnection(conn);
        });
      }

      function setupConnection(conn) {
        connections[conn.peer] = conn;
        if (!document.getElementById("user-" + conn.peer)) {
          let userDiv = document.createElement("div");
          userDiv.textContent = conn.peer;
          userDiv.className = "user";
          userDiv.id = "user-" + conn.peer;
          userDiv.onclick = () => switchChat(conn.peer);
          document.getElementById("userList").appendChild(userDiv);
        }
        conn.on("data", (data) => {
          if (data.type === "text") addMessage(data.msg, "other", conn.peer);
          if (data.type === "file") showFile(data, "other", conn.peer);
        });
      }

      function switchChat(id) {
        currentChat = id;
        document
          .querySelectorAll(".user")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById("user-" + id).classList.add("active");
        document.getElementById("messages").innerHTML = "";
      }

      function sendMessage() {
        let msg = document.getElementById("messageInput").value;
        if (msg && currentChat && connections[currentChat]) {
          connections[currentChat].send({ type: "text", msg });
          addMessage(msg, "me", currentChat);
          document.getElementById("messageInput").value = "";
        }
      }

      function sendFile(e) {
        let file = e.target.files[0];
        if (file && currentChat && connections[currentChat]) {
          let reader = new FileReader();
          reader.onload = () => {
            connections[currentChat].send({
              type: "file",
              name: file.name,
              data: reader.result,
            });
            showFile(
              { name: file.name, data: reader.result },
              "me",
              currentChat
            );
          };
          reader.readAsArrayBuffer(file);
        }
      }

      function addMessage(msg, who, chatId) {
        if (chatId !== currentChat) return;
        let div = document.createElement("div");
        div.className = `message ${who}`;
        div.textContent = msg;
        document.getElementById("messages").appendChild(div);
        document.getElementById("messages").scrollTop =
          document.getElementById("messages").scrollHeight;
      }

      function showFile(file, who, chatId) {
        if (chatId !== currentChat) return;
        let div = document.createElement("div");
        div.className = `message ${who}`;
        let link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([file.data]));
        link.download = file.name;
        link.textContent = "üìé " + file.name;
        link.target = "_blank";
        div.appendChild(link);
        document.getElementById("messages").appendChild(div);
        document.getElementById("messages").scrollTop =
          document.getElementById("messages").scrollHeight;
      }

      function toggleQR() {
        const qr = document.getElementById("qrContainer");
        qr.style.display = qr.style.display === "none" ? "block" : "none";
      }

      // Auto-connect on page load (if saved peer ID exists)
      window.onload = () => {
        const storedID = prompt(
          "Enter friend's ID to connect (or leave blank)"
        );
        if (storedID) connectTo(storedID);
      };
    </script>
  </body>
</html>
